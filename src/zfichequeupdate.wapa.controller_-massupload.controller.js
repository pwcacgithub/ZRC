sap.ui.define([                                                                                                                                                                                                                                                
	"sap/ui/core/mvc/Controller",                                                                                                                                                                                                                                 
	"UpdateCheque/util/PostDocument",                                                                                                                                                                                                                             
	"sap/m/Dialog",                                                                                                                                                                                                                                               
	"sap/m/Button",                                                                                                                                                                                                                                               
	"sap/m/Text"                                                                                                                                                                                                                                                  
], function(Controller, PostDocument, Dialog, Button, Text) {                                                                                                                                                                                                  
	"use strict";                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
	return Controller.extend("UpdateCheque.controller.MassUpload", {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
		_PostDocument: PostDocument,                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
		onInit: function() {                                                                                                                                                                                                                                         
			this._oRouter = sap.ui.core.UIComponent.getRouterFor(this);                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			var oMessageManager = sap.ui.getCore().getMessageManager();                                                                                                                                                                                                 
			var oMessageProcessor = oMessageManager.getMessageModel();                                                                                                                                                                                                  
			oMessageManager.registerMessageProcessor(oMessageProcessor);                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
			this.getView().setModel(sap.ui.getCore().getMessageManager().getMessageModel(), "messages");                                                                                                                                                                
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		handleUpload: function() {                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
			var oBackground = this.getView().byId("idBackground");                                                                                                                                                                                                      
			var bBackground = oBackground.getSelected();                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
			var oCompanyCode = this.getView().byId("idCompanyCode");                                                                                                                                                                                                    
			var sCompanyCode = oCompanyCode.getValue();                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			// if (!sCompanyCode || sCompanyCode === "") {                                                                                                                                                                                                              
			// 	sap.m.MessageToast.show("Please Enter the Company Code");                                                                                                                                                                                               
			// 	return;                                                                                                                                                                                                                                                 
			// }                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			var oFileUploader = this.getView().byId("idDocFile");                                                                                                                                                                                                       
			var domRef = oFileUploader.getFocusDomRef();                                                                                                                                                                                                                
			var file = domRef.files[0];                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			if (!file) {                                                                                                                                                                                                                                                
				// No File - Trigger an Message&nbsp;                                                                                                                                                                                                                      
				sap.m.MessageToast.show("Please Select a File to Upload");                                                                                                                                                                                                 
				return;                                                                                                                                                                                                                                                    
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			var that = this;                                                                                                                                                                                                                                            
			var oController = this;                                                                                                                                                                                                                                     
			sap.ui.core.BusyIndicator.show();                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			// Create a File Reader object                                                                                                                                                                                                                              
			var reader = new FileReader();                                                                                                                                                                                                                              
			reader.onload = function(e) {                                                                                                                                                                                                                               
				var bstr = e.target.result;                                                                                                                                                                                                                                
				var workbook = XLSX.read(bstr, {                                                                                                                                                                                                                           
					type: 'binary'                                                                                                                                                                                                                                            
				});                                                                                                                                                                                                                                                        
				var aData = that.convertToJSON(workbook);                                                                                                                                                                                                                  
				var oData = JSON.parse(aData);                                                                                                                                                                                                                             
				var aFileData = oData["File Format"];                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
				// It is assumed that the file always comes with Header                                                                                                                                                                                                    
				// {"Documentnumber":"0100014044","Companycode":"1710","Fiscalyear":"2017","Assignment":"9686863597"}                                                                                                                                                      
				var oTableData = {                                                                                                                                                                                                                                         
					"Documentnumber": "",                                                                                                                                                                                                                                     
					"Companycode": "",                                                                                                                                                                                                                                        
					"Fiscalyear": "",                                                                                                                                                                                                                                         
					"Assignment": ""                                                                                                                                                                                                                                          
				};                                                                                                                                                                                                                                                         
				var aTableData = [];                                                                                                                                                                                                                                       
				$.each(aFileData, function(index, oRow) {                                                                                                                                                                                                                  
					if (index === 0) {                                                                                                                                                                                                                                        
						return true;                                                                                                                                                                                                                                             
					}                                                                                                                                                                                                                                                         
					if (oRow && oRow.length > 0) {                                                                                                                                                                                                                            
						var oTableRow = jQuery.extend({}, oTableData);                                                                                                                                                                                                           
						oTableRow.Documentnumber = oRow[0];                                                                                                                                                                                                                      
						oTableRow.Companycode = oRow[24];                                                                                                                                                                                                                        
						var sDocDate = oRow[4];                                                                                                                                                                                                                                  
						oTableRow.Fiscalyear = sDocDate.substr(6, 4);                                                                                                                                                                                                            
						oTableRow.Assignment = oRow[11];                                                                                                                                                                                                                         
						                                                                                                                                                                                                                                                         
						if ( sCompanyCode === oTableRow.Companycode || sCompanyCode === "" ){                                                                                                                                                                                    
							aTableData.push(oTableRow);	                                                                                                                                                                                                                            
						}                                                                                                                                                                                                                                                        
					} else {                                                                                                                                                                                                                                                  
						return false;                                                                                                                                                                                                                                            
					}                                                                                                                                                                                                                                                         
				});                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				var oModel = that.getView().getModel("foregroundData");                                                                                                                                                                                                    
				oModel.setData({                                                                                                                                                                                                                                           
					"data": aTableData                                                                                                                                                                                                                                        
				});                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				if (bBackground) {                                                                                                                                                                                                                                         
					// Else Do the Job and Display the Message                                                                                                                                                                                                                
					var oPostingModel = that.getView().getModel();                                                                                                                                                                                                            
					var oPostingData = {                                                                                                                                                                                                                                      
						"count": "1",                                                                                                                                                                                                                                            
						// E2P system                                                                                                                                                                                                                                            
						// "NP_Fb02_Head_Item": aTableData                                                                                                                                                                                                                       
						// E2T system                                                                                                                                                                                                                                            
						"fb02_itemSet": aTableData                                                                                                                                                                                                                               
					};                                                                                                                                                                                                                                                        
					var oController = that;                                                                                                                                                                                                                                   
					                                                                                                                                                                                                                                                          
					sap.ui.getCore().getMessageManager().removeAllMessages();                                                                                                                                                                                                 
					                                                                                                                                                                                                                                                          
					oPostingModel.create("/fb02_headSet", oPostingData, {                                                                                                                                                                                                     
						success: function(oData, oResponse) {                                                                                                                                                                                                                    
							// debugger;                                                                                                                                                                                                                                            
							//console.log(that);                                                                                                                                                                                                                                    
							sap.m.MessageToast.show("Click on the Message Icon at the bottom to see the log");                                                                                                                                                                      
						},                                                                                                                                                                                                                                                       
						error: function(oResponse) {                                                                                                                                                                                                                             
							// debugger;                                                                                                                                                                                                                                            
							//sap.m.MessageToast.show("Document Posting Failed");                                                                                                                                                                                                   
							sap.m.MessageToast.show("Click on the Message Icon at the bottom to see the log");                                                                                                                                                                      
						}                                                                                                                                                                                                                                                        
					});                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
					//this._PostDocument.UpdateDocuments(oPostingData,oPostingModel);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                   
                                                                                                                                                                                                                                                               
				} else {                                                                                                                                                                                                                                                   
					that._oRouter.navTo("DocumentDisplay");                                                                                                                                                                                                                   
				}                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
				sap.ui.core.BusyIndicator.hide();                                                                                                                                                                                                                          
			};                                                                                                                                                                                                                                                          
			reader.readAsBinaryString(file);                                                                                                                                                                                                                            
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Convert the Work Book data to JSON                                                                                                                                                                                                                        
		 * Caution: Method copied from js-xlsx plugin                                                                                                                                                                                                                
		 * Do not modify.                                                                                                                                                                                                                                            
		 */                                                                                                                                                                                                                                                          
		convertToJSON: function(workbook) {                                                                                                                                                                                                                          
			var result = {};                                                                                                                                                                                                                                            
			workbook.SheetNames.forEach(function(sheetName) {                                                                                                                                                                                                           
				var roa = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {                                                                                                                                                                                           
					header: 1                                                                                                                                                                                                                                                 
				});                                                                                                                                                                                                                                                        
				if (roa.length) result[sheetName] = roa;                                                                                                                                                                                                                   
			});                                                                                                                                                                                                                                                         
			return JSON.stringify(result, 2, 2);                                                                                                                                                                                                                        
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		handleMessagesPress: function(oEvent) {                                                                                                                                                                                                                      
			// Get a reference to the button that raised this event                                                                                                                                                                                                     
			var oSource = oEvent.getSource();                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			// Create an instance of the MessagePopover control. Store a reference to the created popover so that we create it only once.                                                                                                                               
			if (!this._oMessagePopover) {                                                                                                                                                                                                                               
				// Instantiate                                                                                                                                                                                                                                             
				this._oMessagePopover = sap.ui.xmlfragment("UpdateCheque.fragments.message");                                                                                                                                                                              
				this.getView().addDependent(this._oMessagePopover);                                                                                                                                                                                                        
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			// Open the MessagePopover                                                                                                                                                                                                                                  
			this._oMessagePopover.openBy(oSource);                                                                                                                                                                                                                      
		},                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                             
		clearMessages: function(oEvent) {                                                                                                                                                                                                                            
			                                                                                                                                                                                                                                                            
			var dialog = new Dialog({                                                                                                                                                                                                                                   
				title: 'Confirm',                                                                                                                                                                                                                                          
				type: 'Message',                                                                                                                                                                                                                                           
				content: new Text({ text: 'Do you want to clear the messages?' }),                                                                                                                                                                                         
				beginButton: new Button({                                                                                                                                                                                                                                  
					text: 'Yes',                                                                                                                                                                                                                                              
					press: function () {                                                                                                                                                                                                                                      
						// MessageToast.show('Submit pressed!');                                                                                                                                                                                                                 
						sap.ui.getCore().getMessageManager().removeAllMessages();                                                                                                                                                                                                
						dialog.close();                                                                                                                                                                                                                                          
					}                                                                                                                                                                                                                                                         
				}),                                                                                                                                                                                                                                                        
				endButton: new Button({                                                                                                                                                                                                                                    
					text: 'Cancel',                                                                                                                                                                                                                                           
					press: function () {                                                                                                                                                                                                                                      
						dialog.close();                                                                                                                                                                                                                                          
					}                                                                                                                                                                                                                                                         
				}),                                                                                                                                                                                                                                                        
				afterClose: function() {                                                                                                                                                                                                                                   
					dialog.destroy();                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
			dialog.open();                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                             
		//F4                                                                                                                                                                                                                                                         
		                                                                                                                                                                                                                                                             
		handleValueHelp: function(oEvent) {                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			var sInputValue = oEvent.getSource().getValue();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
			this.inputId = oEvent.getSource().getId();                                                                                                                                                                                                                  
			// create value help dialog                                                                                                                                                                                                                                 
			if (!this._valueHelpDialog) {                                                                                                                                                                                                                               
				this._valueHelpDialog = sap.ui.xmlfragment(                                                                                                                                                                                                                
					"UpdateCheque.fragments.Dialog",                                                                                                                                                                                                                          
					this                                                                                                                                                                                                                                                      
				);                                                                                                                                                                                                                                                         
				this.getView().addDependent(this._valueHelpDialog);                                                                                                                                                                                                        
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			// create a filter for the binding                                                                                                                                                                                                                          
			this._valueHelpDialog.getBinding("items").filter([new sap.ui.model.Filter(                                                                                                                                                                                  
				"Bukrs",                                                                                                                                                                                                                                                   
				sap.ui.model.FilterOperator.Contains, sInputValue                                                                                                                                                                                                          
			)]);                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			// open value help dialog filtered by the input value                                                                                                                                                                                                       
			this._valueHelpDialog.open(sInputValue);                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_handleValueHelpSearch: function(evt) {                                                                                                                                                                                                                      
			var sValue = evt.getParameter("value");                                                                                                                                                                                                                     
			var oFilter = new sap.ui.model.Filter(                                                                                                                                                                                                                      
				"Bukrs",                                                                                                                                                                                                                                                   
				sap.ui.model.FilterOperator.Contains, sValue                                                                                                                                                                                                               
			);                                                                                                                                                                                                                                                          
			evt.getSource().getBinding("items").filter([oFilter]);                                                                                                                                                                                                      
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_handleValueHelpClose: function(evt) {                                                                                                                                                                                                                       
			var oSelectedItem = evt.getParameter("selectedItem");                                                                                                                                                                                                       
			if (oSelectedItem) {                                                                                                                                                                                                                                        
				var oCompanyCode = this.byId(this.inputId);                                                                                                                                                                                                                
				oCompanyCode.setValue(oSelectedItem.getTitle());                                                                                                                                                                                                           
			}                                                                                                                                                                                                                                                           
			evt.getSource().getBinding("items").filter([]);                                                                                                                                                                                                             
		}                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
	});                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
});                                                                                                                                                                                                                                                            